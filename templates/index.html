<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diablo Trade Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #console {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            background: #111212;  /* Preserving your original background color */
        }
        .console-line {
            margin: 5px 0;
            word-wrap: break-word;
        }
        .timestamp {
            color: #888;
        }
        .item-card {
            background: transparent;  /* Make background transparent */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0;  /* Remove padding */
            margin-bottom: 1rem;
            position: relative;  /* For price bar positioning */
        }

        .item-image {
            width: 360px;     /* Base width */
            height: 470px;    /* Base height */
            object-fit: contain;
            margin: 0;        /* Remove margins */
        }

        .item-price {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            font-size: 1.1rem;
            color: #fff;
            font-weight: 600;
            background: rgba(40, 167, 69, 0.8);  /* Semi-transparent green */
            padding: 0.5rem;
            text-align: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .btn-danger {
            border-radius: 0 0 8px 8px;  /* Round only bottom corners */
            margin: 0;
            width: 100%;
        }

        /* Grid layout styles */
        #itemGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-dark text-white">

<div class="container mt-5">
    <h1 class="text-center mb-4">Diablo Trade Control Panel</h1>

    <div class="row">
        <div class="col-md-4">
            <!-- Directory Input -->
            <div class="mb-3">
                <label for="directory" class="form-label">Working Directory</label>
                <input type="text" id="directory" class="form-control" value="C:\items">
            </div>

            <button class="btn btn-primary btn-block w-100 mb-2" onclick="sendRequest('delete_items')">Delete Items</button>
            <button class="btn btn-secondary btn-block w-100 mb-2" onclick="sendRequest('post_items')">Post Items</button>
            
            <!-- Cut Price Section -->
            <label for="cutPercentage" class="form-label">Cut Percentage (%)</label>
            <input type="number" id="cutPercentage" class="form-control mb-2" value="10" min="0" max="100">
            <button class="btn btn-info btn-block w-100 mb-2" onclick="cutPrices()">Cut Prices</button>

            <button id="captureToggle" class="btn btn-success btn-block w-100 mb-2" onclick="toggleCapture()">
                Start Capture
            </button>
        </div>

        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Console Output:</h4>
                <button class="btn btn-sm btn-outline-light" onclick="clearConsole()">Clear Console</button>
            </div>
            <div id="console">
            </div>
        </div>
    </div>
    <div class="item-grid" id="itemGrid">
        <!-- Items will be dynamically added here -->
    </div>
</div>

<!-- Bootstrap 5 JS + Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function getTimestamp() {
        return new Date().toLocaleTimeString();
    }

    function getDirectory() {
        return $('#directory').val().trim() || "C:\\Users\\zeros\\Desktop\\d4web\\items";
    }

    function sendRequest(route) {
        const requestData = {
            directory: getDirectory()
        };

        // Disable all buttons during request
        $('button').prop('disabled', true);

        $.ajax({
            url: '/' + route,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                updateConsole(response.message, 'success');
                if (response.details) {
                    console.log('Details:', response.details);
                    updateConsole(JSON.stringify(response.details, null, 2), 'info');
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = "Error occurred";
                try {
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                } catch (e) {
                    errorMessage = error || "Unknown error occurred";
                }
                updateConsole(errorMessage, 'error');
            },
            complete: function() {
                // Re-enable all buttons after request completes
                $('button').prop('disabled', false);
            }
        });
    }

    function cutPrices() {
        const percent = parseFloat($('#cutPercentage').val());
        if (isNaN(percent) || percent < 0 || percent > 100) {
            updateConsole("Invalid percentage value. Please enter a number between 0 and 100.", 'error');
            return;
        }

        const requestData = {
            directory: getDirectory(),
            percent: percent
        };

        // Disable all buttons during request
        $('button').prop('disabled', true);

        $.ajax({
            url: '/cut_percent',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                updateConsole(response.message, 'success');
                if (response.details) {
                    const details = `Processed files - Success: ${response.details.success_count}, Errors: ${response.details.error_count}`;
                    updateConsole(details, 'info');
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = "Error occurred";
                try {
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                } catch (e) {
                    errorMessage = error || "Unknown error occurred";
                }
                updateConsole(errorMessage, 'error');
            },
            complete: function() {
                // Re-enable all buttons after request completes
                $('button').prop('disabled', false);
            }
        });
    }

    function updateConsole(message, type = 'info') {
    const timestamp = `<span class="timestamp">[${getTimestamp()}]</span>`;
    let messageClass = '';

    switch(type) {
        case 'error':
            messageClass = 'error-message';
            break;
        case 'success':
            messageClass = 'success-message';
            break;
        case 'warning':
            messageClass = 'warning-message';
            break;
        default:
            messageClass = '';
    }

    const formattedMessage = `${timestamp} <span class="${messageClass}">${message}</span>`;
    // Corrected line: use #console instead of #console-output
    const consoleOutput = $("#console");  
    consoleOutput.append(`<div class="console-line">${formattedMessage}</div>`);

    const consoleDiv = document.getElementById("console");
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

    function clearConsole() {
    document.getElementById('console').innerHTML = ''; // Directly clear the content of the console div
}

    // Initial console message
    $(document).ready(function() {
        updateConsole("System initialized. Ready for commands...", 'success');
    });
    let captureStatusInterval = null;

function toggleCapture() {
    const btn = $('#captureToggle');
    const isStarting = btn.text().includes('Start');
    
    // Disable button during request
    btn.prop('disabled', true);
    
    $.ajax({
        url: '/capture_toggle',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            directory: getDirectory()
        }),
        success: function(response) {
            if (response.is_capturing) {
                btn.removeClass('btn-success').addClass('btn-danger');
                btn.text('Stop Capture');
                startStatusPolling();
                updateConsole("Capture started successfully", 'success');
            } else {
                btn.removeClass('btn-danger').addClass('btn-success');
                btn.text('Start Capture');
                stopStatusPolling();
                updateConsole("Capture stopped successfully", 'success');
            }
        },
        error: function(xhr, status, error) {
            updateConsole(`Failed to ${isStarting ? 'start' : 'stop'} capture: ${error}`, 'error');
        },
        complete: function() {
            btn.prop('disabled', false);
        }
    });
}

function startStatusPolling() {
    if (captureStatusInterval) {
        clearInterval(captureStatusInterval);
    }
    
    // Poll status every 1 second
    captureStatusInterval = setInterval(checkCaptureStatus, 1000);
}

function stopStatusPolling() {
    if (captureStatusInterval) {
        clearInterval(captureStatusInterval);
        captureStatusInterval = null;
    }
}

function checkCaptureStatus() {
    $.ajax({
        url: '/capture_status',
        type: 'GET',
        success: function(response) {
            if (!response.is_capturing) {
                stopStatusPolling();
                $('#captureToggle').removeClass('btn-danger').addClass('btn-success').text('Start Capture');
                if (response.last_error) {
                    updateConsole(`Capture stopped due to error: ${response.last_error}`, 'error');
                }
                return;
            }
            
            // Display new captures
            if (response.captured_items && response.captured_items.length > 0) {
                response.captured_items.forEach(item => {
                    const message = `Captured: ${item.item_name} (${item.price})`;
                    if (!$('#console-output').text().includes(message)) {
                        updateConsole(message, 'success');
                    }
                });
            }
            
            if (response.last_error) {
                updateConsole(`Capture error: ${response.last_error}`, 'error');
            }
        },
        error: function(xhr, status, error) {
            updateConsole(`Status check failed: ${error}`, 'error');
            stopStatusPolling();
        }
    });
}

// Add event listener for page unload to stop capture
window.addEventListener('beforeunload', function() {
    if ($('#captureToggle').text().includes('Stop')) {
        $.ajax({
            url: '/capture_toggle',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                directory: getDirectory()
            }),
            async: false
        });
    }
});
const itemGrid = document.getElementById('itemGrid');

// Function to format price
function formatPrice(price) {
    if (price >= 1_000_000_000) {
        return (price / 1_000_000_000).toFixed(1) + 'b';
    } else if (price >= 1_000_000) {
        return (price / 1_000_000).toFixed(1) + 'm';
    }
    return price.toString();
}

// Function to load and display items
let previousItemCount = 0; // Initialize previous item count

async function loadItems() {
    try {
        const response = await fetch('/api/items');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const items = await response.json();

        if (items.error) {
            console.error('Server error:', items.error);
            appendToConsole('Error loading items: ' + items.error);
            return;
        }

        // Clear existing items *before* adding new ones
        itemGrid.innerHTML = ''; // Always clear the grid

        // Add all items to the grid
        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'item-card';
            itemElement.innerHTML = `
                <div class="item-price">${formatPrice(item.price)}</div>
                <img src="${item.image || '/templates/default.png'}" 
                     alt="${item.name}" 
                     class="item-image"
                     onerror="this.src='/templates/default.png'">
                <button class="btn btn-danger" 
                        onclick="deleteItem('${item.folder_name}')">
                    Delete Item
                </button>
            `;
            itemGrid.appendChild(itemElement);
        });

        // Log message only if the count has changed or it's the initial load
        if (items.length !== previousItemCount || previousItemCount === 0) {
            appendToConsole(`Loaded ${items.length} items`);
            previousItemCount = items.length;
        }

    } catch (error) { /* ... your existing error handling ... */ }
}

// Make sure to load items when the page loads
document.addEventListener('DOMContentLoaded', loadItems);
// Function to delete an item
async function deleteItem(itemId) {
    try {
        const response = await fetch('/api/items/' + encodeURIComponent(itemId), {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadItems(); // Reload the grid
            appendToConsole(`Deleted item: ${itemId}`);
        } else {
            throw new Error('Failed to delete item');
        }
    } catch (error) {
        console.error('Error deleting item:', error);
        appendToConsole('Error deleting item: ' + error.message);
    }
}

// Function to append text to console
function appendToConsole(text) {
    const consoleOutput = document.getElementById('console');
    const timestamp = new Date().toLocaleTimeString();

    // Create a new div for each message
    const messageLine = document.createElement('div');
    messageLine.className = 'console-line'; // Optional: Add a class for styling
    messageLine.textContent = `[${timestamp}] ${text}`;

    consoleOutput.appendChild(messageLine); // Append the new div
    consoleOutput.scrollTop = consoleOutput.scrollHeight; // Scroll to the bottom
}


// Initial load
loadItems();
</script>

</body>
</html>